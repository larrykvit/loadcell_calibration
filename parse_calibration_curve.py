"""
Uses the lodacell calibration curves and generates a calibration value.

Requires 2 curves - one from a calibrated loadcell, and one from the loadcell
under test.
"""

import numpy as np
#import matplotlib.pyplot as plt
from scipy.interpolate import CubicSpline

def interpolate_2x(vals):
    """Cubic interpolation in between each value"""
    xp = np.arange(0, len(vals), 1)  # indexes
    x = np.arange(0, len(vals)-0.5, 0.5)  # half step indexes
    assert len(xp) * 2 - 1 == len(x)

    # There are some peak loads when the motor stops, so a cubic spline fits
    # better than just linear interpolation. And the acceleration is smoother.
    vals_spline = CubicSpline(xp, vals)

    # vals_linear = np.interp(x, xp, vals)
    
    # plt.plot(x, vals_linear, label="linear")
    # plt.plot(x, vals_spline(x), label="cubic")
    # plt.plot(xp, vals, 'o', label='data')
    # plt.legend(loc='best')
    # plt.show()
    return vals_spline(x)


def line_fit_residual(x,y):
    """Calculate how close the points fit to a line"""
    assert len(x) == len(y)
    assert x.ndim == 1
    assert y.ndim == 1
    # lol, this is the new np.polyfit
    _, (resid, _, _, _) = np.polynomial.polynomial.Polynomial.fit(x,y,1, full=True)
    return resid[0]


def parse_calibration_curve(
    values_ref: list[float],
    values_dut: list[float],
    scale_ref: float,
    ):
    # Tare isn't needed - curve fitting a line with offset is more accurate.
    # Its only needed if you are just looking at the ratio of the two inputs.
    # TODO - figure out if the tare is really needed, or if you should just
    # curve fit a line with an offset
    values_ref = np.array(values_ref)
    values_dut = np.array(values_dut)

    # The ADC muxes between the 2 values. So they are offest by half a sample.
    # Also, the sampling could have started and stopped on either channel.
    # A A A A  vs  A A A A
    #  B B B B    B B B B
    # Upscale the data by 2x, so that the offset is now 1 sample
    # When plotting dut vs ref, the data should be ideally a straight line;
    # this means that they both are reading the same values. If it is a straight
    # line offset in either direction (due to moving forwards and backwards)
    # that means the data is offset.
    # Offset the data in either direction and see which one has less error.
    # This assumes the testing data has both increasing and decreasing values.
    # Since that will produce a shift in both directions.

    interp_ref = interpolate_2x(values_ref)
    interp_dut = interpolate_2x(values_dut)

    # The shift should make the plot of ref vs dut be a line. When it isn't
    # there will be a shift in both directions from this line.
    min_len = min(len(interp_ref),  len(interp_dut))
    slice_shift_back = slice(1, min_len)
    slice_no_shift = slice(0, min_len-1)

    cut_dut, cut_ref = min(
        (interp_dut[slice_shift_back], interp_ref[slice_no_shift]),  # DUT first
        (interp_dut[slice_no_shift], interp_ref[slice_shift_back]),  # REF first
        key=lambda x: line_fit_residual(*x)
    )


    # TODO think about removing high acceleration points
    slice_to_fit = slice(100, 500)  # TODO figure out the best way to get this
    # diff_ref = np.diff(cut_ref, n=1)
    # diff_dut = np.diff(cut_dut, n=1)


    # scale_ref * value_ref = scale_dut * value_dut (same weight)
    # scale_ref * value_ref/ value_dut = scale_dut

    print("fitline")
    fit_line, (resid, _, _, _) = np.polynomial.polynomial.Polynomial.fit(
        cut_dut[slice_to_fit],cut_ref[slice_to_fit], 1, full=True)
    fit_coef = fit_line.convert().coef
    scale_dut = fit_coef[1] * scale_ref
    print("scale", scale_dut)
    print("error from  spec:", (1 - scale_dut / 100000)*100, "%")
    print("error at 200kg (if using 2mv/V):", 200 - scale_dut * 0.002)
    print("offset", fit_coef[0])
    print("residual", resid[0])

    return scale_dut, resid[0]



if __name__ == "__main__":

    LOADCELL_REF_FSO = 3.0049 / 1000  # Full Scale output in V/V
    LOADCELL_REF_CAPACITY = 500 * 0.45359237  # in kg converted from lbs

    LOADCELL_REF_SCALE = LOADCELL_REF_CAPACITY / LOADCELL_REF_FSO  # kg / V/V
    # 1/1.3249341032786773e-05 = 75475.45176212187

    # Mavin NA128 is 2mv/V at 200kg
    # 2/1000 V/V / 200 kg = 0.00001 V/V / kg = 1e-05
    # 1/ 1e-05 V/V / kg = 100'000 kg / V/V

    # Sample data
    # TODO read from the data folder instead
    # tare_ref = -7.643053929011026e-06
    # tare_dut = -8.271541446447372e-06

    values_ref = [-7.64988362789154e-06, -7.655471563339233e-06, -7.631257176399231e-06, -7.670372724533081e-06, -7.659196853637695e-06, -7.64802098274231e-06, -7.613562047481537e-06, -7.61914998292923e-06, -7.63963907957077e-06, -7.654540240764618e-06, -7.640570402145386e-06, -7.612630724906921e-06, -7.613562047481537e-06, -7.61914998292923e-06, -3.877095878124237e-06, -2.8219074010849e-06, -1.884065568447113e-06, -1.1185184121131897e-06, -5.792826414108276e-07, 5.485489964485168e-07, 1.2563541531562805e-06, 2.2044405341148376e-06, 4.493631422519684e-06, 5.884096026420593e-06, 7.555820047855377e-06, 9.113922715187073e-06, 1.0536983609199524e-05, 1.2462958693504333e-05, 1.4156103134155273e-05, 1.5916302800178528e-05, 1.8458813428878784e-05, 2.063717693090439e-05, 2.3311935365200043e-05, 2.6452355086803436e-05, 3.014504909515381e-05, 3.399234265089035e-05, 3.8392841815948486e-05, 4.664808511734009e-05, 5.945377051830292e-05, 7.617194205522537e-05, 0.00010942202061414719, 0.0001564575359225273, 0.00021165143698453903, 0.0002731550484895706, 0.0003379983827471733, 0.00040649622678756714, 0.0004777926951646805, 0.0005507878959178925, 0.0006263498216867447, 0.0007038312032818794, 0.0007819961756467819, 0.0008594123646616936, 0.0009360695257782936, 0.0010116174817085266, 0.0010849973186850548, 0.0011569540947675705, 0.001227174885571003, 0.0012951679527759552, 0.0013612974435091019, 0.0014260057359933853, 0.0014879647642374039, 0.0015488434582948685, 0.0016093142330646515, 0.0016691992059350014, 0.0017288131639361382, 0.0017869407311081886, 0.0018442124128341675, 0.0019012484699487686, 0.0019573746249079704, 0.0020122788846492767, 0.002064739353954792, 0.0020750295370817184, 0.0020595062524080276, 0.0020378660410642624, 0.0020132558420300484, 0.0019901366904377937, 0.0019684555009007454, 0.0019488967955112457, 0.0019281813874840736, 0.0019086236134171486, 0.0018885787576436996, 0.0018690070137381554, 0.0018473491072654724, 0.0018265461549162865, 0.0018058381974697113, 0.0017854617908596992, 0.0017641577869653702, 0.0017440449446439743, 0.0017251037061214447, 0.0017064791172742844, 0.0016870852559804916, 0.0016672825440764427, 0.0016480349004268646, 0.0016282862052321434, 0.001608964055776596, 0.0015890970826148987, 0.001570550724864006, 0.0015511997044086456, 0.0015330305323004723, 0.001514551229774952, 0.0014975806698203087, 0.0014789244160056114, 0.0014608018100261688, 0.0014422852545976639, 0.0014251414686441422, 0.0014068493619561195, 0.00138900987803936, 0.0013711294159293175, 0.0013545611873269081, 0.0013378113508224487, 0.001320376992225647, 0.0013035554438829422, 0.001286698505282402, 0.001270153559744358, 0.0012522032484412193, 0.001235567033290863, 0.001218518242239952, 0.0012018447741866112, 0.001184258610010147, 0.0011684652417898178, 0.001151934266090393, 0.0011361995711922646, 0.0011191768571734428, 0.001103544607758522, 0.0010868487879633904, 0.0010707853361964226, 0.0010538296774029732, 0.0010385038331151009, 0.0010223109275102615, 0.0010067280381917953, 0.000990760512650013, 0.000975840725004673, 0.0009597521275281906, 0.0009436830878257751, 0.0009271251037716866, 0.0009117210283875465, 0.0008960040286183357, 0.0008797487244009972, 0.000863875262439251, 0.0008484525606036186, 0.0008333064615726471, 0.0008178278803825378, 0.0008024526759982109, 0.0007872963324189186, 0.0007721511647105217, 0.0007579326629638672, 0.0007491614669561386, 0.0007293401286005974, 0.0007118573412299156, 0.000697367824614048, 0.0006825104355812073, 0.0006680097430944443, 0.0006539300084114075, 0.0006459644064307213, 0.0006338115781545639, 0.0006196144968271255, 0.0006064232438802719, 0.000593273900449276, 0.0005798032507300377, 0.0005663558840751648, 0.000553324818611145, 0.0005412241443991661, 0.0005286522209644318, 0.000517101027071476, 0.0005050981417298317, 0.0004948116838932037, 0.0004836414009332657, 0.0004728827625513077, 0.00046152155846357346, 0.0004514511674642563, 0.00044166669249534607, 0.00043116509914398193, 0.0004220893606543541, 0.00041220523416996, 0.00040390249341726303, 0.00039489660412073135, 0.00038557499647140503, 0.0003773374482989311, 0.00036805402487516403, 0.00036070775240659714, 0.00035265833139419556, 0.0003442326560616493, 0.0003368360921740532, 0.0003281598910689354, 0.00032118242233991623, 0.0003141658380627632, 0.0003057308495044708, 0.00029859691858291626, 0.0002911016345024109, 0.0002837507054209709, 0.00027779117226600647, 0.0002701403573155403, 0.0002629496157169342, 0.00025650113821029663, 0.00024901051074266434, 0.00024302955716848373, 0.0002365047112107277, 0.00022955331951379776, 0.0002237437292933464, 0.00021673087030649185, 0.000209808349609375, 0.0002041524276137352, 0.00019731372594833374, 0.00019125733524560928, 0.00018543750047683716, 0.00017845071852207184, 0.00017266813665628433, 0.00016675610095262527, 0.0001604091376066208, 0.00015541445463895798, 0.0001496216282248497, 0.00014328770339488983, 0.00013850070536136627, 0.0001329062506556511, 0.00012773647904396057, 0.00012359675019979477, 0.00011794641613960266, 0.00011234916746616364, 0.00010825321078300476, 0.00010310672223567963, 9.840913116931915e-05, 9.469594806432724e-05, 8.960720151662827e-05, 8.477829396724701e-05, 8.12700018286705e-05, 7.691141217947006e-05, 7.335096597671509e-05, 7.049739360809326e-05, 6.68717548251152e-05, 6.393995136022568e-05, 6.139464676380157e-05, 5.858391523361206e-05, 5.6255608797073364e-05, 5.3944066166877747e-05, 5.119573324918747e-05, 4.921574145555496e-05, 4.7720037400722504e-05, 4.62578609585762e-05, 4.523061215877533e-05, 4.4397078454494476e-05, 4.3645501136779785e-05, 4.338845610618591e-05, 4.333816468715668e-05, 4.3297186493873596e-05, 4.330091178417206e-05, 4.3227337300777435e-05, 4.3111853301525116e-05, 4.277564585208893e-05, 4.202406853437424e-05, 4.079937934875488e-05, 3.974791616201401e-05, 3.8458965718746185e-05, 3.7307851016521454e-05, 3.6689452826976776e-05, 3.601331263780594e-05, 3.545545041561127e-05, 3.513414412736893e-05, 3.476906567811966e-05, 3.459956496953964e-05, 3.456883132457733e-05, 3.4290365874767303e-05, 3.4091994166374207e-05, 3.3709220588207245e-05, 3.283936530351639e-05, 3.203563392162323e-05, 3.105495125055313e-05, 2.976134419441223e-05, 2.8619542717933655e-05, 2.7254223823547363e-05, 2.644304186105728e-05, 2.529192715883255e-05, 2.3595988750457764e-05, 2.2484920918941498e-05, 2.1453946828842163e-05, 2.09687277674675e-05, 2.0466744899749756e-05, 1.9533559679985046e-05, 1.845322549343109e-05, 1.714751124382019e-05, 1.5955418348312378e-05, 1.5100464224815369e-05, 1.4229677617549896e-05, 1.372210681438446e-05, 1.3097189366817474e-05, 1.2631528079509735e-05, 1.2250617146492004e-05, 1.1689029633998871e-05, 1.122988760471344e-05, 1.0702759027481079e-05, 1.0110437870025635e-05, 9.587965905666351e-06, 8.965842425823212e-06, 8.462928235530853e-06, 7.80448317527771e-06, 7.000751793384552e-06, 6.202608346939087e-06, 5.234032869338989e-06, 4.491768777370453e-06, 3.6070123314857483e-06, 2.825632691383362e-06, 2.164393663406372e-06, 1.477077603340149e-06, 9.462237358093262e-07, 4.079192876815796e-07, -5.3085386753082275e-08, -4.5262277126312256e-07, -8.540228009223938e-07, -1.1539086699485779e-06, -1.5320256352424622e-06, -1.716427505016327e-06, -2.0759180188179016e-06, -2.462416887283325e-06, -2.902001142501831e-06, -3.4300610423088074e-06, -3.832392394542694e-06, -4.235655069351196e-06, -4.514120519161224e-06, -4.7460198402404785e-06, -4.93321567773819e-06, -5.057081580162048e-06, -5.172565579414368e-06, -5.2694231271743774e-06, -5.377456545829773e-06, -5.502253770828247e-06, -5.692243576049805e-06, -5.908310413360596e-06, -6.1141327023506165e-06, -6.2659382820129395e-06, -6.40377402305603e-06, -6.523914635181427e-06, -7.64802098274231e-06, -7.897615432739258e-06, -7.908791303634644e-06, -7.923692464828491e-06, -7.889233529567719e-06, -7.922761142253876e-06, -7.931143045425415e-06, -7.914379239082336e-06, -7.93207436800003e-06, -7.908791303634644e-06, -7.919035851955414e-06, -7.946975529193878e-06, -7.91158527135849e-06, -7.929280400276184e-06, -7.927417755126953e-06, -7.926486432552338e-06, -7.912516593933105e-06, -7.910653948783875e-06, -7.954426109790802e-06]
    values_dut = [-8.248724043369293e-06, -8.291564881801605e-06, -8.252449333667755e-06, -8.288770914077759e-06, -8.291564881801605e-06, -8.279457688331604e-06, -8.277595043182373e-06, -8.279457688331604e-06, -8.298084139823914e-06, -8.276663720607758e-06, -8.288770914077759e-06, -8.298084139823914e-06, -8.277595043182373e-06, -8.266419172286987e-06, -6.052665412425995e-06, -4.851259291172028e-06, -4.215165972709656e-06, -3.5800039768218994e-06, -3.102235496044159e-06, -2.4782493710517883e-06, -1.753680408000946e-06, -1.1650845408439636e-06, -2.1420419216156006e-08, 1.5832483768463135e-06, 2.6943162083625793e-06, 3.8994476199150085e-06, 5.000270903110504e-06, 6.254762411117554e-06, 7.66012817621231e-06, 8.84663313627243e-06, 1.0610558092594147e-05, 1.2411735951900482e-05, 1.421663910150528e-05, 1.6324222087860107e-05, 1.9055791199207306e-05, 2.204813063144684e-05, 2.4870038032531738e-05, 2.9165297746658325e-05, 3.727991133928299e-05, 4.873983561992645e-05, 6.583984941244125e-05, 9.781867265701294e-05, 0.00013699103146791458, 0.0001818118616938591, 0.0002300916239619255, 0.00028138235211372375, 0.0003345320001244545, 0.0003890674561262131, 0.00044588930904865265, 0.0005042599514126778, 0.0005639800801873207, 0.0006234664469957352, 0.0006817514076828957, 0.0007403818890452385, 0.0007971050217747688, 0.0008524255827069283, 0.0009067598730325699, 0.0009593106806278229, 0.0010107588022947311, 0.0010607242584228516, 0.001109117642045021, 0.0011556576937437057, 0.0012018680572509766, 0.0012477850541472435, 0.001293170265853405, 0.0013382919132709503, 0.0013824570924043655, 0.0014257663860917091, 0.0014689192175865173, 0.0015114424750208855, 0.0015535159036517143, 0.001582765020430088, 0.001575356349349022, 0.0015610931441187859, 0.0015425924211740494, 0.0015242816880345345, 0.0015070587396621704, 0.0014914320781826973, 0.001476118341088295, 0.0014606118202209473, 0.0014454610645771027, 0.0014304667711257935, 0.0014146855100989342, 0.0013984106481075287, 0.001382441259920597, 0.0013670092448592186, 0.0013507576659321785, 0.0013351384550333023, 0.0013200575485825539, 0.0013060849159955978, 0.0012911157682538033, 0.001276535913348198, 0.0012611597776412964, 0.0012466562911868095, 0.0012313025072216988, 0.0012166490778326988, 0.0012017162516713142, 0.0011874698102474213, 0.0011729756370186806, 0.00115895364433527, 0.001145578920841217, 0.001132017932832241, 0.0011180108413100243, 0.001103668473660946, 0.0010904287919402122, 0.0010766061022877693, 0.0010631978511810303, 0.0010490519925951958, 0.0010363515466451645, 0.001023266464471817, 0.001010635867714882, 0.0009970590472221375, 0.0009846007451415062, 0.0009715883061289787, 0.0009588031098246574, 0.0009450577199459076, 0.0009325984865427017, 0.0009195413440465927, 0.0009066006168723106, 0.0008937893435359001, 0.000881577841937542, 0.0008692843839526176, 0.0008567571640014648, 0.000844322144985199, 0.0008319541811943054, 0.0008195368573069572, 0.0008066995069384575, 0.0007946761325001717, 0.0007824292406439781, 0.0007706079632043839, 0.0007581571117043495, 0.0007468648254871368, 0.0007347352802753448, 0.0007227566093206406, 0.00070987269282341, 0.0006980365142226219, 0.0006858194246888161, 0.0006740428507328033, 0.0006611747667193413, 0.0006497176364064217, 0.0006377315148711205, 0.0006265006959438324, 0.0006142100319266319, 0.000603020191192627, 0.0005911542102694511, 0.0005799289792776108, 0.0005714148283004761, 0.000563434325158596, 0.0005448544397950172, 0.0005340790376067162, 0.0005225781351327896, 0.0005119657143950462, 0.0005005970597267151, 0.0004913331940770149, 0.00048576854169368744, 0.0004748636856675148, 0.00046401098370552063, 0.0004544137045741081, 0.00044396892189979553, 0.0004339898005127907, 0.0004235329106450081, 0.00041442178189754486, 0.0004048757255077362, 0.000395800918340683, 0.00038655195385217667, 0.0003782520070672035, 0.0003699641674757004, 0.0003614947199821472, 0.0003533158451318741, 0.00034471694380044937, 0.0003376556560397148, 0.0003297245129942894, 0.00032244715839624405, 0.0003151232376694679, 0.0003079744055867195, 0.0003017047420144081, 0.0002945205196738243, 0.00028813257813453674, 0.00028132088482379913, 0.0002746526151895523, 0.0002692015841603279, 0.0002627568319439888, 0.00025694631040096283, 0.00025063659995794296, 0.00024432502686977386, 0.00023962277919054031, 0.000233527272939682, 0.00022730045020580292, 0.0002220524474978447, 0.00021624751389026642, 0.00021142978221178055, 0.00020612869411706924, 0.0002002241089940071, 0.00019547902047634125, 0.00018995441496372223, 0.00018448103219270706, 0.00018021836876869202, 0.00017484929412603378, 0.00017000362277030945, 0.00016524922102689743, 0.0001597180962562561, 0.0001552468165755272, 0.00015031173825263977, 0.00014526862651109695, 0.000141155906021595, 0.00013604946434497833, 0.00013085734099149704, 0.00012686755508184433, 0.00012200791388750076, 0.0001174798235297203, 0.00011377781629562378, 0.00010897964239120483, 0.00010467227548360825, 0.00010094605386257172, 9.661819785833359e-05, 9.328499436378479e-05, 8.956808596849442e-05, 8.512567728757858e-05, 8.162762969732285e-05, 7.807742804288864e-05, 7.418263703584671e-05, 7.126852869987488e-05, 6.773602217435837e-05, 6.384309381246567e-05, 6.091315299272537e-05, 5.781371146440506e-05, 5.4652802646160126e-05, 5.2500516176223755e-05, 4.987884312868118e-05, 4.723668098449707e-05, 4.5404769480228424e-05, 4.330836236476898e-05, 4.124920815229416e-05, 3.9638951420783997e-05, 3.758631646633148e-05, 3.5655684769153595e-05, 3.4516677260398865e-05, 3.334321081638336e-05, 3.237184137105942e-05, 3.174971789121628e-05, 3.103446215391159e-05, 3.068707883358002e-05, 3.06498259305954e-05, 3.060232847929001e-05, 3.057904541492462e-05, 3.060046583414078e-05, 3.0528753995895386e-05, 3.0317343771457672e-05, 2.999231219291687e-05, 2.9141083359718323e-05, 2.8244219720363617e-05, 2.7437694370746613e-05, 2.645794302225113e-05, 2.5806017220020294e-05, 2.5311484932899475e-05, 2.487190067768097e-05, 2.452172338962555e-05, 2.4263747036457062e-05, 2.400018274784088e-05, 2.3968517780303955e-05, 2.3898668587207794e-05, 2.3669563233852386e-05, 2.3509375751018524e-05, 2.2992491722106934e-05, 2.2314488887786865e-05, 2.1687708795070648e-05, 2.0829029381275177e-05, 1.9900500774383545e-05, 1.8889084458351135e-05, 1.807417720556259e-05, 1.7418526113033295e-05, 1.625809818506241e-05, 1.5090219676494598e-05, 1.4334917068481445e-05, 1.3801269233226776e-05, 1.353491097688675e-05, 1.2942589819431305e-05, 1.2121163308620453e-05, 1.1241063475608826e-05, 1.02166086435318e-05, 9.554438292980194e-06, 8.848495781421661e-06, 8.299946784973145e-06, 7.895752787590027e-06, 7.456168532371521e-06, 7.202848792076111e-06, 6.834976375102997e-06, 6.385147571563721e-06, 6.054528057575226e-06, 5.624257028102875e-06, 5.241483449935913e-06, 4.823319613933563e-06, 4.328787326812744e-06, 3.93204391002655e-06, 3.3657997846603394e-06, 2.7222558856010437e-06, 2.0954757928848267e-06, 1.391395926475525e-06, 8.558854460716248e-07, 1.5925616025924683e-07, -3.511086106300354e-07, -9.015202522277832e-07, -1.362524926662445e-06, -1.759268343448639e-06, -2.175569534301758e-06, -2.436339855194092e-06, -2.798624336719513e-06, -3.014691174030304e-06, -3.296881914138794e-06, -3.475695848464966e-06, -3.666616976261139e-06, -3.959983587265015e-06, -4.259869456291199e-06, -4.627741873264313e-06, -5.017966032028198e-06, -5.276873707771301e-06, -5.550682544708252e-06, -5.749054253101349e-06, -5.926936864852905e-06, -6.010755896568298e-06, -6.125308573246002e-06, -6.173737347126007e-06, -6.274320185184479e-06, -6.3497573137283325e-06, -6.467103958129883e-06, -6.664544343948364e-06, -6.765127182006836e-06, -6.92903995513916e-06, -6.993301212787628e-06, -7.1320682764053345e-06, -7.465481758117676e-06, -8.21240246295929e-06, -8.218921720981598e-06, -8.207745850086212e-06, -8.217990398406982e-06, -8.20402055978775e-06, -8.213333785533905e-06, -8.215196430683136e-06, -8.218921720981598e-06, -8.194707334041595e-06, -8.205883204936981e-06, -8.229166269302368e-06, -8.218921720981598e-06, -8.219853043556213e-06, -8.221715688705444e-06, -8.225440979003906e-06, -8.215196430683136e-06, -8.249655365943909e-06, -8.231960237026215e-06, -8.218921720981598e-06]

    parse_calibration_curve(values_ref, values_dut, LOADCELL_REF_SCALE)


